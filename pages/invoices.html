<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/app.css">
    <style>
        /* Local overrides or specific styles */
        .group-title {
            font-weight: bold;
            margin-top: 25px;
            background: var(--bg-main);
            padding: 10px;
            border-radius: 6px;
            border-right: 4px solid var(--primary);
            margin-bottom: 10px;
            color: var(--primary);
        }

        img.logo {
            width: 180px;
            display: block;
            margin: 10px auto 20px auto;
        }

        #addGuestBtn {
            background: var(--success);
            margin-top: 10px;
            width: auto;
            display: block;
            margin-right: auto;
            margin-left: auto;
            padding: 10px 30px;
            border-radius: 8px;
        }

        #totalField {
            background-color: #e9ecef;
            font-weight: bold;
            color: var(--text-main);
            font-size: 1.1em;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        /* Invoice Section Styles */
        .invoices-section {
            margin-top: 40px;
            border-top: 2px dashed var(--border);
            padding-top: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .refresh-btn {
            background: var(--text-secondary);
            width: auto;
            padding: 8px 15px;
            margin: 0;
            font-size: 14px;
            border-radius: 8px;
            color: white;
            border: none;
            cursor: pointer;
        }

        .refresh-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .invoice-card {
            background: white;
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .invoice-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .invoice-info {
            text-align: right;
        }

        .invoice-info strong {
            display: block;
            margin-bottom: 4px;
            color: var(--primary);
            font-size: 1.1em;
        }

        .invoice-info span {
            font-size: 12px;
            color: var(--text-secondary);
            display: block;
        }

        .invoice-link {
            text-decoration: none;
            background: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            white-space: nowrap;
            margin-right: 10px;
            transition: all 0.2s;
        }

        .invoice-link:hover {
            background: #082244;
            transform: translateY(-1px);
        }

        .empty-msg {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-style: italic;
        }

        #editModeAlert {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: center;
            display: none;
        }

        #editModeAlert a {
            color: #856404;
            font-weight: bold;
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <!-- Toolbar -->
    <div class="app-toolbar">
        <div class="toolbar-left">
            <a href="../index.html" class="back-btn">
                <i class="fas fa-arrow-right"></i>
            </a>
            <h2 class="app-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
        </div>
        <div class="toolbar-right">
            <button class="toolbar-btn refresh" onclick="loadInvoices()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Content -->
    <div class="app-content-full">

        <div id="loginBox" class="container">
            <img class="logo" src="https://iroom.ai/web/image/website/1/logo/iroom?unique=89c76a1" alt="Logo">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
            <form id="loginForm">
                <div class="row">
                    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" required>
                </div>
                <div class="row">
                    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                </div>
                <button type="submit" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </form>
            <p id="loginMsg" style="text-align:center; color:var(--danger); margin-top:10px;"></p>
        </div>

        <div id="appBox" class="container" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <img class="logo" src="https://iroom.ai/web/image/website/1/logo/iroom?unique=89c76a1" alt="Logo"
                    style="margin:0; width:120px;">
                <div style="text-align: left;">
                    <div style="margin-bottom:5px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="userName"
                            style="font-weight:bold; color:var(--primary);"></span></div>
                    <button onclick="logout()" class="btn-danger"
                        style="padding:5px 15px; font-size:14px; width:auto; margin:0;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>

            <h2 id="formTitle">Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ Ø­Ø¬Ø² (ÙŠØ¯ÙˆÙŠ)</h2>

            <div id="editModeAlert">
                Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©. <a href="#" onclick="resetFormToDefault(); return false;">Ø¥Ù„ØºØ§Ø¡
                    Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</a>
            </div>

            <form id="bookingForm">
                <div class="row">
                    <input type="text" name="invoice" id="invoiceNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©" required readonly
                        style="background:#f9f9f9;">
                    <input type="text" name="clientName" placeholder="Ø¥Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
                </div>
                <div class="row">
                    <input type="text" name="clientPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" required>
                    <input type="text" name="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                </div>
                <div class="row">
                    <input type="email" name="clientEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                </div>

                <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">

                <div class="row">
                    <input type="text" name="hotelName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙÙ†Ø¯Ù‚" required>
                    <input type="text" name="hotelPhone" placeholder="Ø¬ÙˆØ§Ù„ Ø§Ù„ÙÙ†Ø¯Ù‚">
                </div>
                <div class="row">
                    <input type="email" name="hotelEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙÙ†Ø¯Ù‚ÙŠ">
                    <input type="text" name="todayDate" id="todayField" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…" readonly>
                </div>

                <div id="guestContainer"></div>

                <button id="addGuestBtn" type="button" onclick="addGuest()">+ Ø¥Ø¶Ø§ÙØ© Ø¶ÙŠÙ</button>

                <div class="row" style="margin-top:20px;">
                    <label style="padding:10px; font-weight:bold; display:flex; align-items:center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ
                        (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©):</label>
                    <input type="text" name="total" id="totalField" placeholder="0.00" readonly>
                </div>

                <button type="submit" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            </form>

            <div class="invoices-section">
                <div class="section-header">
                    <h3 style="margin:0; color:var(--primary);">ğŸ“‚ Ø¢Ø®Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
                    <button type="button" class="refresh-btn" onclick="loadInvoices()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <div id="invoiceList">
                    <p class="empty-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>

    </div>

    <div id="messageBox" style="position:fixed; top:20px; right:20px; z-index:9999; display:none;">
        <div id="messageContent"
            style="padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); min-width:250px; max-width:400px; color:white;">
        </div>
    </div>

    <div id="confirmBox"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:none; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:25px; border-radius:10px; width:90%; max-width:400px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:var(--primary);">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
            <p id="confirmText" style="color:var(--text-secondary); font-size:16px; margin:20px 0;"></p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button id="confirmYesBtn" class="btn-danger" style="width:auto; padding:8px 25px;">Ù†Ø¹Ù…</button>
                <button onclick="closeConfirm()" class="btn-warning"
                    style="width:auto; padding:8px 25px;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // Ø±Ø§Ø¨Ø· Google Apps Script Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBt3Dm6LX1CKwg3Nw1pzz4UeJit6j31GxaON04BmhVXBvWj2ivrjTZ_GB6t-KOtzv0/exec";

        let guestCount = 0;
        let currentUser = null;
        let isEditMode = false;

        // --- Helper Functions ---

        function generateInvoice() {
            if (isEditMode) return;
            invoiceNumber.value = "INV-" + Math.floor(Math.random() * 1000000);
            const d = new Date();
            todayField.value = formatDateForInput(d);
        }

        function formatDateForInput(dateVal) {
            if (!dateVal) return "";
            let d = new Date(dateVal);
            if (isNaN(d.getTime())) return "";

            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function addGuest() {
            guestCount++;

            if (guestCount > 4) {
                showMessage("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† 4 Ø¶ÙŠÙˆÙ", "error");
                guestCount--;
                return;
            }

            const div = document.createElement("div");
            div.innerHTML = `
    <div class="group-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶ÙŠÙ ${guestCount}</div>
    <div class="row">
      <input name="name${guestCount}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ">
      <input type="date" name="checkin${guestCount}" onchange="calcNights(${guestCount})">
    </div>
    <div class="row">
      <input type="date" name="checkout${guestCount}" onchange="calcNights(${guestCount})">
      <input name="nights${guestCount}" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ" readonly style="background:#eee;">
    </div>
    <div class="row">
      <select name="type${guestCount}">
        <option value="">â€” Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ© â€”</option>
        <option value="Ù…ÙØ±Ø¯Ø©">Ù…ÙØ±Ø¯Ø©</option>
        <option value="Ù…Ø²Ø¯ÙˆØ¬Ø©">Ù…Ø²Ø¯ÙˆØ¬Ø©</option>
        <option value="Ø«Ù„Ø§Ø«ÙŠØ©">Ø«Ù„Ø§Ø«ÙŠØ©</option>
        <option value="Ø±Ø¨Ø§Ø¹ÙŠØ©">Ø±Ø¨Ø§Ø¹ÙŠØ©</option>
        <option value="Ø®Ù…Ø§Ø³ÙŠØ©">Ø®Ù…Ø§Ø³ÙŠØ©</option>
      </select>
      <input type="number" name="rooms${guestCount}" value="1" min="1" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù">
    </div>
    <div class="row">
      <input type="number" name="amount${guestCount}" step="0.01" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ" oninput="calcTotal()" style="border-color: var(--success);">
    </div>
  `;
            guestContainer.appendChild(div);

            if (guestCount >= 4) {
                document.getElementById('addGuestBtn').disabled = true;
                document.getElementById('addGuestBtn').textContent = 'ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (4 Ø¶ÙŠÙˆÙ)';
            }
        }

        function calcNights(i) {
            const form = document.getElementById('bookingForm');
            const checkin = form[`checkin${i}`].value;
            const checkout = form[`checkout${i}`].value;
            if (checkin && checkout) {
                const diff = new Date(checkout) - new Date(checkin);
                const nights = Math.max(0, diff / (1000 * 60 * 60 * 24));
                form[`nights${i}`].value = nights + " Ù„ÙŠÙ„Ø©";
            } else {
                form[`nights${i}`].value = "";
            }
        }

        function calcTotal() {
            let sum = 0;
            const inputs = document.querySelectorAll("input[name^='amount']");
            inputs.forEach(input => {
                sum += parseFloat(input.value) || 0;
            });
            document.getElementById('totalField').value = sum.toFixed(2);
        }

        async function postToGAS(data) {
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch (error) {
                throw new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
            }
        }

        function prepareGuestDataForSubmission(data) {
            for (let i = 1; i <= guestCount; i++) {
                const typeField = `type${i}`;
                const roomsField = `rooms${i}`;
                if (data[typeField] || data[roomsField]) {
                    const roomType = data[typeField] || "";
                    const roomCount = data[roomsField] || "1";
                    if (roomType) {
                        data[typeField] = `${roomType} X ${roomCount} ØºØ±ÙØ©`;
                    }
                }
            }
            return data;
        }

        // --- Event Handlers ---

        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const msg = document.getElementById('loginMsg');

            btn.disabled = true;
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
            msg.textContent = "";

            try {
                const payload = {
                    action: "login",
                    phone_number: document.getElementById('phone').value,
                    password: document.getElementById('password').value
                };

                const data = await postToGAS(payload);

                if (data.status === "success") {
                    currentUser = data.user;
                    localStorage.setItem("phone_number", currentUser.phone_number);

                    document.getElementById('userName').textContent = currentUser.username;
                    document.getElementById('loginBox').style.display = "none";
                    document.getElementById('appBox').style.display = "block";

                    generateInvoice();
                    guestContainer.innerHTML = "";
                    guestCount = 0;
                    const addGuestBtn = document.getElementById('addGuestBtn');
                    addGuestBtn.disabled = false;
                    addGuestBtn.textContent = '+ Ø¥Ø¶Ø§ÙØ© Ø¶ÙŠÙ';
                    addGuest();
                    loadInvoices();
                } else {
                    msg.textContent = data.message || "Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
                }
            } catch (err) {
                msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
            }
        };

        bookingForm.onsubmit = async (e) => {
            e.preventDefault();
            if (isEditMode) {
                await handleUpdateInvoice();
            } else {
                await handleCreateInvoice();
            }
        };

        async function handleCreateInvoice() {
            const btn = document.getElementById('sendBtn');
            if (!showConfirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;

            btn.disabled = true;
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

            const formData = new FormData(bookingForm);
            let data = Object.fromEntries(formData.entries());
            data.userId = currentUser.id;
            data.action = "create_invoice";

            data = prepareGuestDataForSubmission(data);

            try {
                const res = await postToGAS(data);
                if (res.status === "success") {
                    showMessage("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!", "success");
                    resetFormToDefault();
                    setTimeout(loadInvoices, 1500);
                } else {
                    showMessage("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£: " + res.message, "error");
                }
            } catch (err) {
                showMessage("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + err.message, "error");
            } finally {
                btn.disabled = false;
                btn.textContent = isEditMode ? "ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©" : "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
            }
        }

        async function handleUpdateInvoice() {
            const btn = document.getElementById('sendBtn');
            if (!showConfirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ")) return;

            btn.disabled = true;
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";

            const formData = new FormData(document.getElementById('bookingForm'));
            let data = Object.fromEntries(formData.entries());

            data = prepareGuestDataForSubmission(data);

            try {
                const payload = {
                    action: "update_invoice",
                    invoice_no: data.invoice,
                    updated_data: data,
                    phone_number: currentUser.phone_number
                };

                const response = await postToGAS(payload);
                if (response.status === "success") {
                    showMessage("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!", "success");
                    resetFormToDefault();
                    loadInvoices();
                } else {
                    showMessage("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + response.message, "error");
                }
            } catch (err) {
                showMessage("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + err.message, "error");
            } finally {
                btn.disabled = false;
                if (isEditMode) {
                    btn.textContent = "ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
                } else {
                    btn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
                }
            }
        }

        async function loadInvoices() {
            const list = document.getElementById('invoiceList');
            list.innerHTML = '<p class="empty-msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±...</p>';

            if (!currentUser) return;

            try {
                const payload = {
                    action: "get_invoices",
                    userId: currentUser.id,
                    role: currentUser.role
                };

                const data = await postToGAS(payload);

                if (!data.invoices || data.invoices.length === 0) {
                    list.innerHTML = '<p class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ….</p>';
                    return;
                }

                let html = "";
                data.invoices.forEach(inv => {
                    let buttonsHtml = '';
                    if (currentUser && currentUser.role === "admin") {
                        buttonsHtml = `<button class="btn-warning" style="width:auto;padding:8px 12px;margin:0;font-size:14px;" onclick="showEditInvoice('${inv.invoice_no}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn-danger" style="width:auto;padding:8px 12px;margin:0;font-size:14px;" onclick="deleteInvoice('${inv.invoice_no}')">Ø­Ø°Ù</button>`;
                    }
                    html += `
        <div class="invoice-card">
          <div class="invoice-info">
            <strong>${inv.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</strong>
            <span>ÙØ§ØªÙˆØ±Ø©: ${inv.invoice_no || '#'} | ${inv.date}</span>
          </div>
          <div style="display: flex; gap: 5px;">
            <a class="invoice-link" target="_blank" href="${inv.link}">Ø¹Ø±Ø¶ PDF</a>
            ${buttonsHtml}
          </div>
        </div>
      `;
                });
                list.innerHTML = html;
            } catch (err) {
                list.innerHTML = '<p class="empty-msg" style="color:var(--danger);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>';
                console.error(err);
            }
        }

        async function logout() {
            const phone = localStorage.getItem("phone_number");
            if (phone) {
                postToGAS({ action: "logout", phone_number: phone }).catch(() => { });
            }
            currentUser = null;
            localStorage.removeItem("phone_number");
            document.getElementById('loginBox').style.display = "block";
            document.getElementById('appBox').style.display = "none";
            document.getElementById('loginForm').reset();
        }

        window.onload = async () => {
            const phone = localStorage.getItem("phone_number");
            if (!phone) return;

            document.getElementById('loginMsg').textContent = "Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©...";

            try {
                const res = await postToGAS({ action: "check_session", phone_number: phone });

                if (res.status === "success") {
                    currentUser = res.user;
                    document.getElementById('userName').textContent = currentUser.username;
                    document.getElementById('loginBox').style.display = "none";
                    document.getElementById('appBox').style.display = "block";

                    generateInvoice();
                    const addGuestBtn = document.getElementById('addGuestBtn');
                    addGuestBtn.disabled = false;
                    addGuestBtn.textContent = '+ Ø¥Ø¶Ø§ÙØ© Ø¶ÙŠÙ';
                    addGuest();
                    loadInvoices();
                } else {
                    localStorage.removeItem("phone_number");
                }
            } catch (err) {
                console.error("Session check failed", err);
            } finally {
                document.getElementById('loginMsg').textContent = "";
            }
        };

        async function showEditInvoice(invoiceNo) {
            if (!currentUser || currentUser.role !== "admin") {
                showMessage("Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„", "error");
                return;
            }

            const btn = document.querySelector(`button[onclick="showEditInvoice('${invoiceNo}')"]`);
            const originalText = btn ? btn.textContent : "ØªØ¹Ø¯ÙŠÙ„";
            if (btn) btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...";

            try {
                const payload = {
                    action: "get_invoice_by_number",
                    invoice_no: invoiceNo,
                    phone_number: currentUser.phone_number
                };

                const response = await postToGAS(payload);
                if (response.status === "success" && response.invoice) {
                    fillEditForm(response.invoice);
                } else {
                    showMessage("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©", "error");
                }
            } catch (err) {
                console.error(err);
                showMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©", "error");
            } finally {
                if (btn) btn.textContent = originalText;
            }
        }

        function fillEditForm(invoiceData) {
            try {
                isEditMode = true;

                document.getElementById('formTitle').textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: " + invoiceData.invoice;
                document.getElementById('sendBtn').textContent = "ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
                document.getElementById('editModeAlert').style.display = "block";

                document.getElementById('invoiceNumber').value = invoiceData.invoice || '';
                document.getElementById('invoiceNumber').readOnly = true;

                document.querySelector('[name="clientName"]').value = invoiceData.clientName || '';
                document.querySelector('[name="clientPhone"]').value = invoiceData.clientPhone || '';
                document.querySelector('[name="address"]').value = invoiceData.address || '';
                document.querySelector('[name="clientEmail"]').value = invoiceData.clientEmail || '';
                document.querySelector('[name="hotelName"]').value = invoiceData.hotelName || '';
                document.querySelector('[name="hotelPhone"]').value = invoiceData.hotelPhone || '';
                document.querySelector('[name="hotelEmail"]').value = invoiceData.hotelEmail || '';

                document.querySelector('[name="todayDate"]').value = formatDateForInput(invoiceData.todayDate);

                document.getElementById('guestContainer').innerHTML = '';
                guestCount = 0;

                let maxGuestIndex = 0;
                for (let i = 1; i <= 4; i++) {
                    if (invoiceData[`name${i}`] || invoiceData[`amount${i}`]) {
                        maxGuestIndex = i;
                    }
                }

                if (maxGuestIndex === 0) maxGuestIndex = 1;

                for (let i = 1; i <= maxGuestIndex; i++) {
                    addGuest();

                    const form = document.getElementById('bookingForm');

                    if (form.querySelector(`[name="name${guestCount}"]`)) {
                        form.querySelector(`[name="name${guestCount}"]`).value = invoiceData[`name${i}`] || '';
                        form.querySelector(`[name="checkin${guestCount}"]`).value = formatDateForInput(invoiceData[`checkin${i}`]);
                        form.querySelector(`[name="checkout${guestCount}"]`).value = formatDateForInput(invoiceData[`checkout${i}`]);
                        form.querySelector(`[name="nights${guestCount}"]`).value = invoiceData[`nights${i}`] || '';
                        form.querySelector(`[name="amount${guestCount}"]`).value = invoiceData[`amount${i}`] || '';

                        const rawType = invoiceData[`type${i}`] || '';
                        let roomTypeName = rawType;
                        let roomCount = 1;

                        if (rawType && rawType.includes(' X ')) {
                            const parts = rawType.split(' X ');
                            if (parts.length >= 2) {
                                roomTypeName = parts[0].trim();
                                const countMatch = parts[1].match(/\d+/);
                                if (countMatch) {
                                    roomCount = parseInt(countMatch[0]);
                                }
                            }
                        }

                        const typeSelect = form.querySelector(`[name="type${guestCount}"]`);
                        if (typeSelect) typeSelect.value = roomTypeName;

                        const roomsInput = form.querySelector(`[name="rooms${guestCount}"]`);
                        if (roomsInput) roomsInput.value = roomCount;
                    }
                }

                if (invoiceData.total && invoiceData.total !== "") {
                    document.getElementById('totalField').value = invoiceData.total;
                } else {
                    calcTotal();
                }

                document.getElementById('appBox').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Error filling form:", error);
                showMessage("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", "error");
            }
        }

        function resetFormToDefault() {
            isEditMode = false;

            document.getElementById('formTitle').textContent = "Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ Ø­Ø¬Ø² (ÙŠØ¯ÙˆÙŠ)";
            document.getElementById('sendBtn').textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
            document.getElementById('editModeAlert').style.display = "none";

            document.getElementById('invoiceNumber').readOnly = false;
            document.getElementById('bookingForm').reset();

            document.getElementById('guestContainer').innerHTML = '';
            guestCount = 0;

            const addGuestBtn = document.getElementById('addGuestBtn');
            addGuestBtn.disabled = false;
            addGuestBtn.textContent = '+ Ø¥Ø¶Ø§ÙØ© Ø¶ÙŠÙ';

            addGuest();
            generateInvoice();
        }

        async function deleteInvoice(invoiceNo) {
            if (!currentUser || currentUser.role !== "admin") {
                showMessage("Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø°Ù", "error");
                return;
            }

            if (!showConfirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… " + invoiceNo + "ØŸ\n\nØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆÙ…Ù„Ù PDF Ù…Ù† Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ.")) return;

            try {
                const payload = {
                    action: "delete_invoice",
                    invoice_no: invoiceNo,
                    phone_number: currentUser.phone_number
                };

                const response = await postToGAS(payload);
                if (response.status === "success") {
                    showMessage("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!", "success");
                    loadInvoices();
                } else {
                    showMessage("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + response.message, "error");
                }
            } catch (err) {
                showMessage("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + err.message, "error");
            }
        }

        function showMessage(msg, type) {
            const box = document.getElementById('messageBox');
            const content = document.getElementById('messageContent');
            content.textContent = msg;
            content.style.backgroundColor = type === "error" ? "var(--danger)" : "var(--success)";
            box.style.display = "block";
            setTimeout(() => { box.style.display = "none"; }, 3000);
        }

        let confirmCallback = null;
        function showConfirm(text) {
            return new Promise((resolve) => {
                document.getElementById('confirmText').textContent = text;
                document.getElementById('confirmBox').style.display = "flex";
                document.getElementById('confirmYesBtn').onclick = () => {
                    closeConfirm();
                    resolve(true);
                };
                window.closeConfirm = () => {
                    document.getElementById('confirmBox').style.display = "none";
                    resolve(false);
                };
            });
        }
        window.closeConfirm = function () {
            document.getElementById('confirmBox').style.display = "none";
        };
    </script>

</body>

</html>