<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙƒØ§Øª ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>body { font-family: "Tajawal", sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
<div class="max-w-4xl mx-auto">

<h1 class="text-3xl font-bold mb-6 text-gray-800">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙƒØ§Øª ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚</h1>

<div class="mb-6 relative">
  <input id="q" type="search" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙÙ†Ø¯Ù‚..." 
         class="w-full p-4 rounded-xl shadow border border-gray-300 focus:ring focus:ring-blue-300" autocomplete="off"/>
  <div id="suggestions" class="bg-white shadow rounded-xl border border-gray-200 hidden absolute w-full mt-1 z-50"></div>
</div>

<div id="results" class="space-y-4"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx1KTtXXjV8s5s26fAmrF2MVqnaVUbsmApVbacMeXvLGVcrfZ6pdVqAxnUbzCpqPNrCug/exec";
const API_KEY = "123";

/* JSONP helper */
function jsonpFetch(url){
  return new Promise((resolve, reject) => {
    const callbackName = "cb_" + Math.random().toString(36).substr(2,9);
    window[callbackName] = data => { resolve(data); delete window[callbackName]; script.remove(); };
    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + callbackName;
    script.onerror = () => reject(new Error("Network error"));
    document.body.appendChild(script);
  });
}

/* Elements */
const q = document.getElementById("q");
const results = document.getElementById("results");
const suggestionsBox = document.getElementById("suggestions");

/* Load all hotels */
let allHotels = [];
async function loadHotelsList(){
  try {
    const data = await jsonpFetch(`${API_URL}?action=getAllHotels&key=${API_KEY}`);
    allHotels = data.list || [];
  } catch(err){ console.error(err); }
}
loadHotelsList();

/* Debounce */
let timer = null;
q.addEventListener("input", () => {
  showSuggestions(q.value.trim());
  clearTimeout(timer);
  timer = setTimeout(() => {
    if(q.value.trim().length >= 1) runSearch(q.value.trim());
  }, 300);
});

/* Suggestions */
function showSuggestions(text){
  if(!text || text.length < 1){ suggestionsBox.classList.add("hidden"); return; }
  const filtered = allHotels.filter(h => h.toLowerCase().includes(text.toLowerCase()));
  if(filtered.length === 0){ suggestionsBox.classList.add("hidden"); return; }
  suggestionsBox.innerHTML = filtered.slice(0,7).map(item => `
    <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
         onclick="selectSuggestion('${item.replace(/'/g,"\\'")}')">${item}</div>
  `).join("");
  suggestionsBox.classList.remove("hidden");
}

function selectSuggestion(name){
  q.value = name;
  suggestionsBox.classList.add("hidden");
  runSearch(name, true); // exact match
}

/* Run search */
function runSearch(text, exact=false){
  results.innerHTML = `<div class="p-4 bg-white rounded-xl shadow">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
  const url = `${API_URL}?action=getHotel&name=${encodeURIComponent(text)}&exact=${exact}&key=${API_KEY}`;
  jsonpFetch(url).then(data => render(data)).catch(err => {
    results.innerHTML = `<div class="p-4 bg-red-200 text-red-900 rounded-xl">${err.message}</div>`;
  });
}

/* Render results */
function render(data){
  if(!data.exists){
    results.innerHTML = `<div class="p-4 bg-yellow-100 rounded-xl text-gray-700">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙ†Ø¯Ù‚ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….</div>`;
    return;
  }
  let html = "";
  data.results.forEach(hotel => {
    html += `<div class="p-5 bg-white rounded-2xl shadow border border-gray-200">
      <h2 class="text-2xl font-bold text-blue-700 mb-4">ğŸ¨ ${hotel.hotelName}</h2>
      ${renderOperators(hotel.operators)}
    </div>`;
  });
  results.innerHTML = html;
}

function renderOperators(list){
  if(list.length === 0) return `<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª ØªØ´ØºÙŠÙ„ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙÙ†Ø¯Ù‚.</p>`;
  let html = `<div class="grid gap-4">`;
  list.forEach(op => {
    const emails = op.emails ? op.emails.split(",") : [];
    const whats = op.whatsapps ? op.whatsapps.split(",") : [];
    html += `<div class="p-4 bg-gray-50 border rounded-xl shadow-sm">
      <h3 class="text-xl font-semibold text-gray-800 mb-3">ğŸ‘” ${op.operatorName}</h3>
      <div class="mb-3"><h4 class="font-semibold text-gray-600 mb-1">ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</h4>
        ${emails.length>0 ? emails.map(e=>`<a href="mailto:${e.trim()}" class="text-blue-700 underline block">${e.trim()}</a>`).join("") : `<span class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`}
      </div>
      <div><h4 class="font-semibold text-gray-600 mb-1">ğŸ“± Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙˆØ§ØµÙ„:</h4>
        ${whats.length>0 ? whats.map(num=>{
          const clean = num.replace(/\D/g,"");
          return `<div class="flex items-center gap-3 mb-1">
            <a href="tel:${clean}" class="text-green-700 font-medium underline">${num.trim()}</a>
            <a href="https://wa.me/${clean}" target="_blank" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm">ÙˆØ§ØªØ³Ø§Ø¨</a>
          </div>`;
        }).join("") : `<span class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`}
      </div>
    </div>`;
  });
  html += `</div>`;
  return html;
}
</script>
</body>
</html>
